# Spring Boot çµŒè²»ç®¡ç†ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ - å­¦ç¿’ã‚¬ã‚¤ãƒ‰ï¼ˆæ—¥æœ¬èªç‰ˆï¼‰

**ä½œæˆæ—¥:** 2026-02-11
**ç›®çš„:** ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³ã¨ãƒ™ã‚¹ãƒˆãƒ—ãƒ©ã‚¯ãƒ†ã‚£ã‚¹ã‚’å®Ÿè·µçš„ã«å­¦ã¶

---

## ç›®æ¬¡

1. [ç¾çŠ¶ã®è©•ä¾¡](#ç¾çŠ¶ã®è©•ä¾¡)
2. [æœ€å„ªå…ˆã§å®Ÿè£…ã™ã¹ãæ”¹å–„](#æœ€å„ªå…ˆã§å®Ÿè£…ã™ã¹ãæ”¹å–„)
3. [æ©Ÿèƒ½1: ã‚«ãƒ†ã‚´ãƒªç®¡ç†ï¼ˆåˆç´šï¼‰](#æ©Ÿèƒ½1-ã‚«ãƒ†ã‚´ãƒªç®¡ç†åˆç´š)
4. [æ©Ÿèƒ½2: ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆä¸­ç´šï¼‰](#æ©Ÿèƒ½2-ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ç´š)
5. [æ©Ÿèƒ½3: ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆä¸­ç´šï¼‰](#æ©Ÿèƒ½3-ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ä¸­ç´š)
6. [ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³è§£èª¬](#ãƒ‡ã‚¶ã‚¤ãƒ³ãƒ‘ã‚¿ãƒ¼ãƒ³è§£èª¬)
7. [å­¦ç¿’ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—](#å­¦ç¿’ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—)

---

## ç¾çŠ¶ã®è©•ä¾¡

### âœ… è‰¯ã„ç‚¹

ã‚ãªãŸã®ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã¯ä»¥ä¸‹ã®å¼·ã¿ãŒã‚ã‚Šã¾ã™ï¼š

1. **æ˜ç¢ºãªãƒ¬ã‚¤ãƒ¤ãƒ¼æ§‹é€ **
   - Controllerï¼ˆãƒ—ãƒ¬ã‚¼ãƒ³ãƒ†ãƒ¼ã‚·ãƒ§ãƒ³å±¤ï¼‰
   - Serviceï¼ˆãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯å±¤ï¼‰
   - Repository/Mapperï¼ˆãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹å±¤ï¼‰
   - Domainï¼ˆãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«å±¤ï¼‰

2. **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£æ©Ÿèƒ½**
   - Spring Security + BCrypt
   - ãƒ­ãƒ¼ãƒ«ãƒ™ãƒ¼ã‚¹èªå¯
   - æ¥½è¦³çš„ãƒ­ãƒƒã‚¯
   - ç›£æŸ»ãƒ­ã‚°

3. **ãƒ¢ãƒ€ãƒ³ãªæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯**
   - Java 21
   - Spring Boot 3.x
   - MyBatisï¼ˆSQLã®ç´°ã‹ã„åˆ¶å¾¡ãŒå¯èƒ½ï¼‰
   - Flywayï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼‰

### âš ï¸ æ”¹å–„ãŒå¿…è¦ãªç‚¹

1. **å¯†çµåˆï¼ˆTight Couplingï¼‰**
   - ã‚µãƒ¼ãƒ“ã‚¹ãŒå…·è±¡ã‚¯ãƒ©ã‚¹ã«ç›´æ¥ä¾å­˜
   - é™çš„ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ã‚¯ãƒ©ã‚¹ï¼ˆCurrentUserï¼‰ã§ãƒ†ã‚¹ãƒˆãŒå›°é›£
   - ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ãŒãªã„

2. **è²§è¡€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼ˆAnemic Domain Modelï¼‰**
   - ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ãŒãƒ‡ãƒ¼ã‚¿ã ã‘ã§ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãŒãªã„
   - ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚µãƒ¼ãƒ“ã‚¹å±¤ã«é›†ä¸­

3. **æ‹¡å¼µæ€§ã®æ¬ å¦‚**
   - æ–°æ©Ÿèƒ½è¿½åŠ æ™‚ã«æ—¢å­˜ã‚³ãƒ¼ãƒ‰ã®ä¿®æ­£ãŒå¿…è¦
   - Strategyã€Factoryã€Observerãƒ‘ã‚¿ãƒ¼ãƒ³ãŒæœªä½¿ç”¨

4. **å˜ä¸€è²¬ä»»åŸå‰‡ã®é•å**
   - ExpenseServiceãŒ10ä»¥ä¸Šã®è²¬å‹™ã‚’æŒã¤
   - åˆ†å‰²ãŒå¿…è¦

---

## æœ€å„ªå…ˆã§å®Ÿè£…ã™ã¹ãæ”¹å–„

### æ”¹å–„1: AuthenticationContextã®æŠ½å‡º ğŸ”´ æœ€å„ªå…ˆ

**å•é¡Œç‚¹:**
ç¾åœ¨ã®`CurrentUser`ã‚¯ãƒ©ã‚¹ã¯é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ã£ã¦ã„ã‚‹ãŸã‚ã€ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆãŒå›°é›£ã§ã™ã€‚

**ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰:**
```java
// src/main/java/com/example/expenses/util/CurrentUser.java
public final class CurrentUser {
    private CurrentUser() {}

    // é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ - ãƒ†ã‚¹ãƒˆãŒå›°é›£ï¼
    public static Long actorId() {
        var auth = SecurityContextHolder.getContext().getAuthentication();
        var principal = auth.getPrincipal();

        if(principal instanceof LoginUser loginUser) {
            return loginUser.getUserId();
        }
        throw new IllegalStateException("ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—ã§ãã¾ã›ã‚“");
    }
}

// ã‚µãƒ¼ãƒ“ã‚¹ã§ã®ä½¿ç”¨
@Service
public class ExpenseService {
    public ExpenseResponse create(ExpenseCreateRequest req) {
        Expense expense = new Expense();
        // é™çš„ãƒ¡ã‚½ãƒƒãƒ‰å‘¼ã³å‡ºã— - ãƒ¢ãƒƒã‚¯ã§ããªã„ï¼
        expense.setApplicantId(CurrentUser.actorId());
        // ...
    }
}
```

**å•é¡Œ:**
- é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã¯ãƒ¢ãƒƒã‚¯ã§ããªã„
- ä¾å­˜é–¢ä¿‚ãŒéš ã‚Œã¦ã„ã‚‹ï¼ˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã«è¡¨ã‚Œãªã„ï¼‰
- ãƒ†ã‚¹ãƒˆã§åˆ¥ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’æ³¨å…¥ã§ããªã„

**æ”¹å–„å¾Œã®ã‚³ãƒ¼ãƒ‰:**

**ã‚¹ãƒ†ãƒƒãƒ—1: AuthenticationContextã‚µãƒ¼ãƒ“ã‚¹ã‚’ä½œæˆ**
```java
// src/main/java/com/example/expenses/security/AuthenticationContext.java
package com.example.expenses.security;

import org.springframework.security.core.context.SecurityContextHolder;
import org.springframework.stereotype.Component;
import com.example.expenses.config.LoginUser;
import java.util.List;

/**
 * èªè¨¼æƒ…å ±ã‚’å–å¾—ã™ã‚‹ã‚µãƒ¼ãƒ“ã‚¹ã‚¯ãƒ©ã‚¹
 * é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã®ä»£ã‚ã‚Šã«ã‚¤ãƒ³ã‚¸ã‚§ã‚¯ã‚·ãƒ§ãƒ³å¯èƒ½ãªã‚µãƒ¼ãƒ“ã‚¹ã¨ã—ã¦å®Ÿè£…
 */
@Component
public class AuthenticationContext {

    /**
     * ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
     * @return ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
     * @throws IllegalStateException æœªèªè¨¼ã®å ´åˆ
     */
    public Long getCurrentUserId() {
        var auth = SecurityContextHolder.getContext().getAuthentication();
        var principal = auth.getPrincipal();

        if (principal instanceof LoginUser loginUser) {
            return loginUser.getUserId();
        }
        throw new IllegalStateException("ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒèªè¨¼ã•ã‚Œã¦ã„ã¾ã›ã‚“");
    }

    /**
     * ç¾åœ¨ãƒ­ã‚°ã‚¤ãƒ³ä¸­ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ­ãƒ¼ãƒ«ä¸€è¦§ã‚’å–å¾—
     * @return ãƒ­ãƒ¼ãƒ«ã®ãƒªã‚¹ãƒˆï¼ˆä¾‹: ["ROLE_APPLICANT", "ROLE_APPROVER"]ï¼‰
     */
    public List<String> getCurrentUserRoles() {
        var auth = SecurityContextHolder.getContext().getAuthentication();
        return auth.getAuthorities().stream()
            .map(authority -> authority.getAuthority())
            .toList();
    }

    /**
     * ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒROLE_APPROVERã‚’æŒã£ã¦ã„ã‚‹ã‹ç¢ºèª
     * @return æ‰¿èªè€…ã®å ´åˆtrue
     */
    public boolean isApprover() {
        return getCurrentUserRoles().contains("ROLE_APPROVER");
    }

    /**
     * ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼IDã®æ‰€æœ‰è€…ã€ã¾ãŸã¯æ‰¿èªè€…ã‹ã‚’ç¢ºèª
     * @param ownerId å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
     * @return æ‰€æœ‰è€…ã¾ãŸã¯æ‰¿èªè€…ã®å ´åˆtrue
     */
    public boolean isOwnerOrApprover(Long ownerId) {
        return getCurrentUserId().equals(ownerId) || isApprover();
    }
}
```

**ã‚¹ãƒ†ãƒƒãƒ—2: ã‚µãƒ¼ãƒ“ã‚¹ã«æ³¨å…¥ã—ã¦ä½¿ç”¨**
```java
// src/main/java/com/example/expenses/service/ExpenseService.java
package com.example.expenses.service;

import com.example.expenses.security.AuthenticationContext;
import lombok.RequiredArgsConstructor;
import org.springframework.stereotype.Service;

@Service
@RequiredArgsConstructor  // LombokãŒå…¨finalãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã‚’ç”Ÿæˆ
public class ExpenseService {

    // ä¾å­˜é–¢ä¿‚ã‚’æ˜ç¤ºçš„ã«å®£è¨€ï¼ˆã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ³¨å…¥ï¼‰
    private final ExpenseMapper expenseMapper;
    private final ExpenseAuditLogMapper auditLogMapper;
    private final AuthenticationContext authContext;  // â† æ³¨å…¥ï¼

    /**
     * çµŒè²»ã‚’æ–°è¦ä½œæˆ
     */
    public ExpenseResponse create(ExpenseCreateRequest req) {
        // èªè¨¼ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼IDã‚’å–å¾—
        Long currentUserId = authContext.getCurrentUserId();

        // ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ä½œæˆ
        Expense expense = new Expense();
        expense.setApplicantId(currentUserId);  // ç”³è«‹è€…IDã‚’è¨­å®š
        expense.setTitle(req.title());
        expense.setAmount(req.amount());
        expense.setCurrency(req.currency());
        expense.setStatus(ExpenseStatus.DRAFT);

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        expenseMapper.insert(expense);

        // ç›£æŸ»ãƒ­ã‚°ã‚’è¨˜éŒ²
        auditLogMapper.insert(ExpenseAuditLog.create(
            expense.getId(),
            currentUserId,
            traceId()
        ));

        // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’è¿”ã™
        return ExpenseResponse.toResponse(expense);
    }

    /**
     * çµŒè²»ã‚’æ¤œç´¢
     */
    public PaginationResponse<ExpenseResponse> search(
            ExpenseSearchCriteria criteria,
            int currentPage,
            int pageSize) {

        // ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’å–å¾—
        Long userId = authContext.getCurrentUserId();
        List<String> roles = authContext.getCurrentUserRoles();

        // æ¤œç´¢æ¡ä»¶ã‚’æ§‹ç¯‰
        ExpenseSearchCriteriaEntity searchCriteria = new ExpenseSearchCriteriaEntity();
        searchCriteria.setTitle(criteria.title());
        searchCriteria.setStatus(criteria.status());
        // ... ãã®ä»–ã®æ¡ä»¶ã‚’è¨­å®š

        // æ‰¿èªè€…ä»¥å¤–ã¯è‡ªåˆ†ã®çµŒè²»ã®ã¿è¡¨ç¤º
        if (!authContext.isApprover()) {
            searchCriteria.setApplicantId(userId);
        }

        // æ¤œç´¢å®Ÿè¡Œ
        List<Expense> results = expenseMapper.search(
            searchCriteria,
            calculateOffset(currentPage, pageSize),
            pageSize
        );

        return buildPaginationResponse(results, currentPage, pageSize);
    }
}
```

**ã‚¹ãƒ†ãƒƒãƒ—3: ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’æ›¸ã**
```java
// src/test/java/com/example/expenses/service/ExpenseServiceTest.java
package com.example.expenses.service;

import com.example.expenses.security.AuthenticationContext;
import com.example.expenses.repository.ExpenseMapper;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.extension.ExtendWith;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.junit.jupiter.MockitoExtension;

import static org.assertj.core.api.Assertions.*;
import static org.mockito.ArgumentMatchers.*;
import static org.mockito.Mockito.*;

/**
 * ExpenseServiceã®ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
 * ãƒ¢ãƒƒã‚¯ã‚’ä½¿ç”¨ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãªã—ã§ãƒ†ã‚¹ãƒˆå¯èƒ½
 */
@ExtendWith(MockitoExtension.class)
class ExpenseServiceTest {

    // ãƒ¢ãƒƒã‚¯ï¼ˆå½ç‰©ï¼‰ã‚’ä½œæˆ
    @Mock
    private ExpenseMapper expenseMapper;

    @Mock
    private ExpenseAuditLogMapper auditLogMapper;

    @Mock
    private AuthenticationContext authContext;  // â† ãƒ¢ãƒƒã‚¯å¯èƒ½ï¼

    // ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆãƒ¢ãƒƒã‚¯ã‚’è‡ªå‹•æ³¨å…¥ï¼‰
    @InjectMocks
    private ExpenseService expenseService;

    @Test
    void çµŒè²»ä½œæˆ_æ­£å¸¸ã‚±ãƒ¼ã‚¹() {
        // Givenï¼ˆæº–å‚™ï¼‰: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ç”¨æ„
        Long expectedUserId = 123L;
        ExpenseCreateRequest request = new ExpenseCreateRequest(
            "å‡ºå¼µè²»",
            new BigDecimal("10000"),
            "JPY"
        );

        // ãƒ¢ãƒƒã‚¯ã®æŒ¯ã‚‹èˆã„ã‚’å®šç¾©
        when(authContext.getCurrentUserId()).thenReturn(expectedUserId);

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ä¿å­˜ã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆ
        doAnswer(invocation -> {
            Expense expense = invocation.getArgument(0);
            expense.setId(1L);  // IDã‚’è¨­å®šï¼ˆDBãŒç”Ÿæˆã—ãŸã‹ã®ã‚ˆã†ã«ï¼‰
            return null;
        }).when(expenseMapper).insert(any(Expense.class));

        // Whenï¼ˆå®Ÿè¡Œï¼‰: ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œ
        ExpenseResponse response = expenseService.create(request);

        // Thenï¼ˆæ¤œè¨¼ï¼‰: çµæœã‚’ç¢ºèª
        assertThat(response).isNotNull();
        assertThat(response.applicantId()).isEqualTo(expectedUserId);
        assertThat(response.title()).isEqualTo("å‡ºå¼µè²»");
        assertThat(response.status()).isEqualTo("DRAFT");

        // ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèª
        verify(authContext).getCurrentUserId();
        verify(expenseMapper).insert(any(Expense.class));
        verify(auditLogMapper).insert(any(ExpenseAuditLog.class));
    }

    @Test
    void æ¤œç´¢_æ‰¿èªè€…ä»¥å¤–ã¯è‡ªåˆ†ã®çµŒè²»ã®ã¿å–å¾—() {
        // Given: ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼
        Long userId = 123L;
        List<String> roles = List.of("ROLE_APPLICANT");

        when(authContext.getCurrentUserId()).thenReturn(userId);
        when(authContext.getCurrentUserRoles()).thenReturn(roles);
        when(authContext.isApprover()).thenReturn(false);

        ExpenseSearchCriteria criteria = new ExpenseSearchCriteria(
            null, null, null, null, null, null, null, null
        );

        // When: æ¤œç´¢å®Ÿè¡Œ
        expenseService.search(criteria, 1, 10);

        // Then: è‡ªåˆ†ã®IDã§ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèª
        verify(expenseMapper).search(
            argThat(c -> c.getApplicantId().equals(userId)),
            anyInt(),
            anyInt()
        );
    }

    @Test
    void æ¤œç´¢_æ‰¿èªè€…ã¯å…¨ä»¶å–å¾—å¯èƒ½() {
        // Given: æ‰¿èªè€…
        Long userId = 456L;
        List<String> roles = List.of("ROLE_APPROVER");

        when(authContext.getCurrentUserId()).thenReturn(userId);
        when(authContext.getCurrentUserRoles()).thenReturn(roles);
        when(authContext.isApprover()).thenReturn(true);

        ExpenseSearchCriteria criteria = new ExpenseSearchCriteria(
            null, null, null, null, null, null, null, null
        );

        // When: æ¤œç´¢å®Ÿè¡Œ
        expenseService.search(criteria, 1, 10);

        // Then: applicantIdã§ãƒ•ã‚£ãƒ«ã‚¿ã•ã‚Œã¦ã„ãªã„ã“ã¨ã‚’ç¢ºèª
        verify(expenseMapper).search(
            argThat(c -> c.getApplicantId() == null),
            anyInt(),
            anyInt()
        );
    }
}
```

**ğŸ“š å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ:**

1. **ä¾å­˜æ€§æ³¨å…¥ï¼ˆDependency Injectionï¼‰**
   - é™çš„ãƒ¡ã‚½ãƒƒãƒ‰ã®ä»£ã‚ã‚Šã«ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿æ³¨å…¥ã‚’ä½¿ç”¨
   - ä¾å­˜é–¢ä¿‚ãŒæ˜ç¤ºçš„ã«ãªã‚Šã€ãƒ†ã‚¹ãƒˆã—ã‚„ã™ããªã‚‹

2. **ãƒ¢ãƒƒã‚¯ï¼ˆMockï¼‰ã‚’ä½¿ã£ãŸãƒ†ã‚¹ãƒˆ**
   - `@Mock`: å½ç‰©ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä½œæˆ
   - `@InjectMocks`: ãƒ¢ãƒƒã‚¯ã‚’è‡ªå‹•çš„ã«æ³¨å…¥
   - `when(...).thenReturn(...)`: ãƒ¢ãƒƒã‚¯ã®æŒ¯ã‚‹èˆã„ã‚’å®šç¾©
   - `verify(...)`: ãƒ¡ã‚½ãƒƒãƒ‰ãŒå‘¼ã°ã‚ŒãŸã“ã¨ã‚’ç¢ºèª

3. **ãƒ†ã‚¹ãƒˆã®æ§‹é€ ï¼ˆAAA ãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰**
   - **Arrangeï¼ˆæº–å‚™ï¼‰**: ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã¨ãƒ¢ãƒƒã‚¯ã‚’æº–å‚™
   - **Actï¼ˆå®Ÿè¡Œï¼‰**: ãƒ†ã‚¹ãƒˆå¯¾è±¡ã®ãƒ¡ã‚½ãƒƒãƒ‰ã‚’å®Ÿè¡Œ
   - **Assertï¼ˆæ¤œè¨¼ï¼‰**: çµæœã‚’ç¢ºèª

**æ‰€è¦æ™‚é–“:** 2-3æ™‚é–“
**é›£æ˜“åº¦:** â­â­â˜†â˜†â˜†

---

### æ”¹å–„2: ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•é€šçŸ¥ã‚·ã‚¹ãƒ†ãƒ  ğŸ”´ é«˜å„ªå…ˆåº¦

**å•é¡Œç‚¹:**
ç¾åœ¨ã€ExpenseServiceãŒNotificationServiceã‚’ç›´æ¥å‘¼ã³å‡ºã—ã¦ã„ã‚‹ãŸã‚ã€å¯†çµåˆã«ãªã£ã¦ã„ã¾ã™ã€‚

**ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰:**
```java
@Service
public class ExpenseService {
    // ç›´æ¥ä¾å­˜ - å¯†çµåˆï¼
    private final NotificationService notificationService;

    public ExpenseResponse approve(long expenseId, ...) {
        // ... æ‰¿èªå‡¦ç† ...

        // ç›´æ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡ã‚’å‘¼ã³å‡ºã—
        notificationService.notifyApproved(applicantEmail, expenseId, traceId);

        // å•é¡Œç‚¹:
        // - æ–°ã—ã„é€šçŸ¥æ–¹æ³•ï¼ˆSlackã€SMSç­‰ï¼‰ã‚’è¿½åŠ ã™ã‚‹åº¦ã«ã“ã®ã‚³ãƒ¼ãƒ‰ã‚’å¤‰æ›´
        // - é€šçŸ¥å¤±æ•—æ™‚ã«æ‰¿èªå‡¦ç†å…¨ä½“ãŒå¤±æ•—ã™ã‚‹
        // - é€šçŸ¥å‡¦ç†ãŒé…ã„ã¨æ‰¿èªå‡¦ç†ã‚‚é…ããªã‚‹
    }
}
```

**æ”¹å–„å¾Œã®ã‚³ãƒ¼ãƒ‰ï¼ˆObserverãƒ‘ã‚¿ãƒ¼ãƒ³ / ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ï¼‰:**

**ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚¤ãƒ™ãƒ³ãƒˆã‚’å®šç¾©**
```java
// src/main/java/com/example/expenses/event/ExpenseEvent.java
package com.example.expenses.event;

import java.time.LocalDateTime;
import lombok.Getter;

/**
 * çµŒè²»é–¢é€£ã‚¤ãƒ™ãƒ³ãƒˆã®åŸºåº•ã‚¯ãƒ©ã‚¹
 * å…¨ã¦ã®ã‚¤ãƒ™ãƒ³ãƒˆã§å…±é€šã®æƒ…å ±ã‚’ä¿æŒ
 */
@Getter
public abstract class ExpenseEvent {
    private final Long expenseId;       // çµŒè²»ID
    private final Long actorId;         // æ“ä½œã‚’è¡Œã£ãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ID
    private final String traceId;       // ãƒˆãƒ¬ãƒ¼ã‚¹IDï¼ˆãƒ­ã‚°è¿½è·¡ç”¨ï¼‰
    private final LocalDateTime occurredAt;  // ã‚¤ãƒ™ãƒ³ãƒˆç™ºç”Ÿæ—¥æ™‚

    protected ExpenseEvent(Long expenseId, Long actorId, String traceId) {
        this.expenseId = expenseId;
        this.actorId = actorId;
        this.traceId = traceId;
        this.occurredAt = LocalDateTime.now();
    }
}
```

```java
// src/main/java/com/example/expenses/event/ExpenseApprovedEvent.java
package com.example.expenses.event;

import lombok.Getter;

/**
 * çµŒè²»ãŒæ‰¿èªã•ã‚ŒãŸã¨ãã«ç™ºè¡Œã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
 */
@Getter
public class ExpenseApprovedEvent extends ExpenseEvent {
    private final Long approverId;      // æ‰¿èªè€…ID
    private final Long applicantId;     // ç”³è«‹è€…ID

    public ExpenseApprovedEvent(Long expenseId, Long approverId,
                               Long applicantId, String traceId) {
        super(expenseId, approverId, traceId);
        this.approverId = approverId;
        this.applicantId = applicantId;
    }
}
```

```java
// src/main/java/com/example/expenses/event/ExpenseRejectedEvent.java
package com.example.expenses.event;

import lombok.Getter;

/**
 * çµŒè²»ãŒå´ä¸‹ã•ã‚ŒãŸã¨ãã«ç™ºè¡Œã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
 */
@Getter
public class ExpenseRejectedEvent extends ExpenseEvent {
    private final Long rejectorId;      // å´ä¸‹è€…ID
    private final Long applicantId;     // ç”³è«‹è€…ID
    private final String reason;        // å´ä¸‹ç†ç”±

    public ExpenseRejectedEvent(Long expenseId, Long rejectorId,
                               Long applicantId, String reason, String traceId) {
        super(expenseId, rejectorId, traceId);
        this.rejectorId = rejectorId;
        this.applicantId = applicantId;
        this.reason = reason;
    }
}
```

```java
// src/main/java/com/example/expenses/event/ExpenseSubmittedEvent.java
package com.example.expenses.event;

import lombok.Getter;

/**
 * çµŒè²»ãŒæå‡ºã•ã‚ŒãŸã¨ãã«ç™ºè¡Œã•ã‚Œã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
 */
@Getter
public class ExpenseSubmittedEvent extends ExpenseEvent {
    private final Long applicantId;     // ç”³è«‹è€…ID

    public ExpenseSubmittedEvent(Long expenseId, Long applicantId, String traceId) {
        super(expenseId, applicantId, traceId);
        this.applicantId = applicantId;
    }
}
```

**ã‚¹ãƒ†ãƒƒãƒ—2: ã‚µãƒ¼ãƒ“ã‚¹ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ**
```java
// src/main/java/com/example/expenses/service/ExpenseService.java
package com.example.expenses.service;

import com.example.expenses.event.*;
import org.springframework.context.ApplicationEventPublisher;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import lombok.RequiredArgsConstructor;

@Service
@RequiredArgsConstructor
public class ExpenseService {

    private final ExpenseMapper expenseMapper;
    private final ExpenseAuditLogMapper auditLogMapper;
    private final AuthenticationContext authContext;
    // ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œç”¨ã®ãƒ‘ãƒ–ãƒªãƒƒã‚·ãƒ£ãƒ¼
    private final ApplicationEventPublisher eventPublisher;

    /**
     * çµŒè²»ã‚’æ‰¿èª
     * æ‰¿èªå¾Œã«ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã—ã€ãƒªã‚¹ãƒŠãƒ¼ãŒé€šçŸ¥ç­‰ã‚’å®Ÿè¡Œ
     */
    @Transactional
    public ExpenseResponse approve(long expenseId, int version) {
        Long currentUserId = authContext.getCurrentUserId();

        // 1. çµŒè²»ã‚’å–å¾—
        Expense expense = expenseMapper.findById(expenseId);
        if (expense == null) {
            throw new BusinessException("NOT_FOUND", "çµŒè²»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + expenseId);
        }

        // 2. ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
        if (expense.getStatus() != ExpenseStatus.SUBMITTED) {
            throw new BusinessException("INVALID_STATUS", "æå‡ºæ¸ˆã¿ã®çµŒè²»ã®ã¿æ‰¿èªå¯èƒ½ã§ã™");
        }
        if (expense.getVersion() != version) {
            throw new BusinessException("CONCURRENT_MODIFICATION", "ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ›´æ–°ã•ã‚Œã¦ã„ã¾ã™");
        }

        // 3. æ‰¿èªå‡¦ç†ã‚’å®Ÿè¡Œ
        int updated = expenseMapper.approve(expenseId, version);
        if (updated == 0) {
            throw new BusinessException("CONCURRENT_MODIFICATION", "æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }

        // 4. ç›£æŸ»ãƒ­ã‚°ã‚’è¨˜éŒ²
        auditLogMapper.insert(ExpenseAuditLog.createApprove(
            expenseId,
            currentUserId,
            traceId()
        ));

        // 5. ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œï¼ˆã“ã“ãŒé‡è¦ï¼ï¼‰
        // NotificationServiceã‚’ç›´æ¥å‘¼ã°ãšã€ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã™ã‚‹ã ã‘
        eventPublisher.publishEvent(
            new ExpenseApprovedEvent(
                expenseId,
                currentUserId,  // æ‰¿èªè€…ID
                expense.getApplicantId(),  // ç”³è«‹è€…ID
                traceId()
            )
        );
        // â†’ ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ãŒè‡ªå‹•çš„ã«åå¿œã—ã¦é€šçŸ¥ç­‰ã‚’å®Ÿè¡Œ

        // 6. æ›´æ–°å¾Œã®çµŒè²»ã‚’å–å¾—ã—ã¦è¿”ã™
        Expense updated = expenseMapper.findById(expenseId);
        return ExpenseResponse.toResponse(updated);
    }

    /**
     * çµŒè²»ã‚’å´ä¸‹
     */
    @Transactional
    public ExpenseResponse reject(long expenseId, String reason, int version) {
        Long currentUserId = authContext.getCurrentUserId();

        // 1. çµŒè²»ã‚’å–å¾—ã—ã¦æ¤œè¨¼
        Expense expense = expenseMapper.findById(expenseId);
        if (expense == null) {
            throw new BusinessException("NOT_FOUND", "çµŒè²»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        }
        if (expense.getStatus() != ExpenseStatus.SUBMITTED) {
            throw new BusinessException("INVALID_STATUS", "æå‡ºæ¸ˆã¿ã®çµŒè²»ã®ã¿å´ä¸‹å¯èƒ½ã§ã™");
        }

        // 2. å´ä¸‹å‡¦ç†ã‚’å®Ÿè¡Œ
        int updated = expenseMapper.reject(expenseId, version);
        if (updated == 0) {
            throw new BusinessException("CONCURRENT_MODIFICATION", "æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ");
        }

        // 3. ç›£æŸ»ãƒ­ã‚°ã‚’è¨˜éŒ²
        auditLogMapper.insert(ExpenseAuditLog.createReject(
            expenseId, currentUserId, traceId(), reason
        ));

        // 4. ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œ
        eventPublisher.publishEvent(
            new ExpenseRejectedEvent(
                expenseId,
                currentUserId,
                expense.getApplicantId(),
                reason,
                traceId()
            )
        );

        // 5. çµæœã‚’è¿”ã™
        Expense updated = expenseMapper.findById(expenseId);
        return ExpenseResponse.toResponse(updated);
    }

    /**
     * çµŒè²»ã‚’æå‡º
     */
    @Transactional
    public ExpenseResponse submit(Long expenseId) {
        Long currentUserId = authContext.getCurrentUserId();

        // 1. çµŒè²»ã‚’å–å¾—
        Expense expense = expenseMapper.findById(expenseId);
        if (expense == null) {
            throw new NoSuchElementException("çµŒè²»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + expenseId);
        }

        // 2. æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯
        if (!expense.getApplicantId().equals(currentUserId)) {
            throw new BusinessException("NOT_OWNER", "æœ¬äººä»¥å¤–ã¯æå‡ºã§ãã¾ã›ã‚“");
        }

        // 3. æå‡ºå‡¦ç†
        int updated = expenseMapper.submitDraft(expenseId);
        if (updated == 0) {
            throw new BusinessException("INVALID_STATUS", "ä¸‹æ›¸ãçŠ¶æ…‹ã®çµŒè²»ã®ã¿æå‡ºå¯èƒ½ã§ã™");
        }

        // 4. ç›£æŸ»ãƒ­ã‚°
        auditLogMapper.insert(ExpenseAuditLog.createDraft(
            expenseId, currentUserId, traceId()
        ));

        // 5. ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
        eventPublisher.publishEvent(
            new ExpenseSubmittedEvent(
                expenseId,
                currentUserId,
                traceId()
            )
        );

        // 6. çµæœã‚’è¿”ã™
        Expense updated = expenseMapper.findById(expenseId);
        return ExpenseResponse.toResponse(updated);
    }
}
```

**ã‚¹ãƒ†ãƒƒãƒ—3: ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’ä½œæˆ**
```java
// src/main/java/com/example/expenses/listener/ExpenseNotificationListener.java
package com.example.expenses.listener;

import com.example.expenses.event.*;
import com.example.expenses.notification.NotificationService;
import com.example.expenses.repository.UserMapper;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.event.EventListener;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Component;

/**
 * çµŒè²»ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ã—ã¦ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã‚’é€ä¿¡ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼
 *
 * ãƒã‚¤ãƒ³ãƒˆ:
 * - @EventListenerã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã§ã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­
 * - @Asyncã§éåŒæœŸå®Ÿè¡Œï¼ˆãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒé…ãã¦ã‚‚æ‰¿èªå‡¦ç†ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„ï¼‰
 * - é€šçŸ¥å¤±æ•—ã—ã¦ã‚‚ãƒ¡ã‚¤ãƒ³å‡¦ç†ã«ã¯å½±éŸ¿ã—ãªã„
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class ExpenseNotificationListener {

    private final NotificationService notificationService;
    private final UserMapper userMapper;

    /**
     * çµŒè²»ãŒæ‰¿èªã•ã‚ŒãŸã¨ãã®é€šçŸ¥
     */
    @EventListener
    @Async  // éåŒæœŸå®Ÿè¡Œ - ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒé…ãã¦ã‚‚ãƒ¡ã‚¤ãƒ³å‡¦ç†ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„
    public void handleExpenseApproved(ExpenseApprovedEvent event) {
        try {
            log.info("æ‰¿èªã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡: expenseId={}, approverId={}",
                     event.getExpenseId(), event.getApproverId());

            // ç”³è«‹è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
            String applicantEmail = userMapper.findEmailById(event.getApplicantId());

            // ãƒ¡ãƒ¼ãƒ«é€ä¿¡
            notificationService.notifyApproved(
                applicantEmail,
                event.getExpenseId(),
                event.getTraceId()
            );

            log.info("æ‰¿èªé€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†: expenseId={}", event.getExpenseId());

        } catch (Exception e) {
            // ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¦ã‚‚ãƒ¡ã‚¤ãƒ³å‡¦ç†ã«ã¯å½±éŸ¿ã—ãªã„
            log.error("æ‰¿èªé€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: expenseId={}, error={}",
                     event.getExpenseId(), e.getMessage(), e);
            // ãƒ¡ãƒˆãƒªã‚¯ã‚¹ã«è¨˜éŒ²ã—ãŸã‚Šã€ãƒªãƒˆãƒ©ã‚¤ã‚­ãƒ¥ãƒ¼ã«å…¥ã‚ŒãŸã‚Šã™ã‚‹
        }
    }

    /**
     * çµŒè²»ãŒå´ä¸‹ã•ã‚ŒãŸã¨ãã®é€šçŸ¥
     */
    @EventListener
    @Async
    public void handleExpenseRejected(ExpenseRejectedEvent event) {
        try {
            log.info("å´ä¸‹ã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡: expenseId={}, reason={}",
                     event.getExpenseId(), event.getReason());

            // ç”³è«‹è€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—
            String applicantEmail = userMapper.findEmailById(event.getApplicantId());

            // å´ä¸‹ç†ç”±ã‚’å«ã‚ã¦ãƒ¡ãƒ¼ãƒ«é€ä¿¡
            notificationService.notifyRejected(
                applicantEmail,
                event.getExpenseId(),
                event.getReason(),
                event.getTraceId()
            );

            log.info("å´ä¸‹é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†: expenseId={}", event.getExpenseId());

        } catch (Exception e) {
            log.error("å´ä¸‹é€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: expenseId={}",
                     event.getExpenseId(), e);
        }
    }

    /**
     * çµŒè²»ãŒæå‡ºã•ã‚ŒãŸã¨ãã®é€šçŸ¥ï¼ˆæ‰¿èªè€…ã¸ï¼‰
     */
    @EventListener
    @Async
    public void handleExpenseSubmitted(ExpenseSubmittedEvent event) {
        try {
            log.info("æå‡ºã‚¤ãƒ™ãƒ³ãƒˆå—ä¿¡: expenseId={}, applicantId={}",
                     event.getExpenseId(), event.getApplicantId());

            // æ‰¿èªè€…ã®ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã‚’å–å¾—ï¼ˆã„ãšã‚Œã‹ã®æ‰¿èªè€…ï¼‰
            String approverEmail = userMapper.findAnyApproverEmail();

            // æ‰¿èªè€…ã«ãƒ¡ãƒ¼ãƒ«é€ä¿¡
            notificationService.notifySubmitted(
                approverEmail,
                event.getExpenseId(),
                event.getTraceId()
            );

            log.info("æå‡ºé€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å®Œäº†: expenseId={}", event.getExpenseId());

        } catch (Exception e) {
            log.error("æå‡ºé€šçŸ¥ãƒ¡ãƒ¼ãƒ«é€ä¿¡å¤±æ•—: expenseId={}",
                     event.getExpenseId(), e);
        }
    }
}
```

**ã‚¹ãƒ†ãƒƒãƒ—4: æ–°ã—ã„ãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ ï¼ˆExpenseServiceã‚’å¤‰æ›´ã›ãšã«ï¼ï¼‰**
```java
// src/main/java/com/example/expenses/listener/ExpenseAnalyticsListener.java
package com.example.expenses.listener;

import com.example.expenses.event.*;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.event.EventListener;
import org.springframework.stereotype.Component;

/**
 * çµŒè²»ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç›£è¦–ã—ã¦åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²ã™ã‚‹ãƒªã‚¹ãƒŠãƒ¼
 *
 * é‡è¦: ExpenseServiceã‚’ä¸€åˆ‡å¤‰æ›´ã›ãšã«æ–°æ©Ÿèƒ½ã‚’è¿½åŠ ï¼
 * ã“ã‚ŒãŒã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒãƒ£ã®åˆ©ç‚¹
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class ExpenseAnalyticsListener {

    // åˆ†æã‚µãƒ¼ãƒ“ã‚¹ï¼ˆä»Šå¾Œå®Ÿè£…ï¼‰
    // private final AnalyticsService analyticsService;

    /**
     * æ‰¿èªã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²
     */
    @EventListener
    public void onExpenseApproved(ExpenseApprovedEvent event) {
        log.info("åˆ†æ: çµŒè²»æ‰¿èª - expenseId={}, approverId={}",
                event.getExpenseId(), event.getApproverId());

        // åˆ†æãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²
        // - æ‰¿èªã¾ã§ã®æ™‚é–“
        // - æ‰¿èªè€…åˆ¥ã®æ‰¿èªæ•°
        // - æ™‚é–“å¸¯åˆ¥ã®æ‰¿èªãƒ‘ã‚¿ãƒ¼ãƒ³
        // analyticsService.recordApproval(event);
    }

    /**
     * å´ä¸‹ã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²
     */
    @EventListener
    public void onExpenseRejected(ExpenseRejectedEvent event) {
        log.info("åˆ†æ: çµŒè²»å´ä¸‹ - expenseId={}, reason={}",
                event.getExpenseId(), event.getReason());

        // å´ä¸‹ç†ç”±ã®åˆ†æ
        // - å´ä¸‹ç‡ã®è¨ˆç®—
        // - å´ä¸‹ç†ç”±ã®ã‚«ãƒ†ã‚´ãƒªåˆ†é¡
        // analyticsService.recordRejection(event);
    }

    /**
     * æå‡ºã‚¤ãƒ™ãƒ³ãƒˆã‚’è¨˜éŒ²
     */
    @EventListener
    public void onExpenseSubmitted(ExpenseSubmittedEvent event) {
        log.info("åˆ†æ: çµŒè²»æå‡º - expenseId={}, applicantId={}",
                event.getExpenseId(), event.getApplicantId());

        // æå‡ºãƒ‘ã‚¿ãƒ¼ãƒ³ã®åˆ†æ
        // - ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ¥ã®æå‡ºé »åº¦
        // - æå‡ºæ™‚é–“å¸¯ã®å‚¾å‘
        // analyticsService.recordSubmission(event);
    }
}
```

```java
// src/main/java/com/example/expenses/listener/ExpenseSlackNotificationListener.java
package com.example.expenses.listener;

import com.example.expenses.event.*;
import lombok.RequiredArgsConstructor;
import lombok.extern.slf4j.Slf4j;
import org.springframework.context.event.EventListener;
import org.springframework.scheduling.annotation.Async;
import org.springframework.stereotype.Component;

/**
 * Slacké€šçŸ¥ç”¨ã®ãƒªã‚¹ãƒŠãƒ¼
 * ãƒ¡ãƒ¼ãƒ«é€šçŸ¥ã¨ä¸¦è¡Œã—ã¦å‹•ä½œ
 *
 * ExpenseServiceã¯å…¨ãå¤‰æ›´ãªã—ï¼
 */
@Component
@RequiredArgsConstructor
@Slf4j
public class ExpenseSlackNotificationListener {

    // private final SlackService slackService;

    /**
     * é«˜é¡çµŒè²»ï¼ˆ10ä¸‡å††ä»¥ä¸Šï¼‰ãŒæå‡ºã•ã‚ŒãŸã‚‰Slacké€šçŸ¥
     */
    @EventListener
    @Async
    public void onExpenseSubmitted(ExpenseSubmittedEvent event) {
        // å®Ÿè£…ä¾‹:
        // Expense expense = expenseMapper.findById(event.getExpenseId());
        // if (expense.getAmount().compareTo(new BigDecimal("100000")) >= 0) {
        //     slackService.sendMessage(
        //         "#expense-alerts",
        //         String.format("é«˜é¡çµŒè²»ãŒæå‡ºã•ã‚Œã¾ã—ãŸ: %så†† (ID: %d)",
        //             expense.getAmount(), expense.getId())
        //     );
        // }

        log.info("Slacké€šçŸ¥: çµŒè²»æå‡º - expenseId={}", event.getExpenseId());
    }
}
```

**ã‚¹ãƒ†ãƒƒãƒ—5: éåŒæœŸå‡¦ç†ã®è¨­å®š**
```java
// src/main/java/com/example/expenses/config/AsyncConfig.java
package com.example.expenses.config;

import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableAsync;
import org.springframework.scheduling.annotation.AsyncConfigurer;
import org.springframework.scheduling.concurrent.ThreadPoolTaskExecutor;

import java.util.concurrent.Executor;

/**
 * éåŒæœŸå‡¦ç†ã®è¨­å®š
 * @Asyncã‚¢ãƒãƒ†ãƒ¼ã‚·ãƒ§ãƒ³ã‚’ä½¿ãˆã‚‹ã‚ˆã†ã«ã™ã‚‹
 */
@Configuration
@EnableAsync  // éåŒæœŸå‡¦ç†ã‚’æœ‰åŠ¹åŒ–
public class AsyncConfig implements AsyncConfigurer {

    /**
     * éåŒæœŸå‡¦ç†ç”¨ã®ã‚¹ãƒ¬ãƒƒãƒ‰ãƒ—ãƒ¼ãƒ«è¨­å®š
     */
    @Override
    public Executor getAsyncExecutor() {
        ThreadPoolTaskExecutor executor = new ThreadPoolTaskExecutor();

        // ã‚³ã‚¢ã‚¹ãƒ¬ãƒƒãƒ‰æ•°: å¸¸ã«èµ·å‹•ã—ã¦ã„ã‚‹ã‚¹ãƒ¬ãƒƒãƒ‰æ•°
        executor.setCorePoolSize(5);

        // æœ€å¤§ã‚¹ãƒ¬ãƒƒãƒ‰æ•°: è² è·ãŒé«˜ã„æ™‚ã®æœ€å¤§ã‚¹ãƒ¬ãƒƒãƒ‰æ•°
        executor.setMaxPoolSize(10);

        // ã‚­ãƒ¥ãƒ¼ã‚µã‚¤ã‚º: å¾…æ©Ÿã‚¿ã‚¹ã‚¯ã‚’ä¿æŒã™ã‚‹ã‚­ãƒ¥ãƒ¼ã®å®¹é‡
        executor.setQueueCapacity(100);

        // ã‚¹ãƒ¬ãƒƒãƒ‰åã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ï¼ˆãƒ­ã‚°ã§è­˜åˆ¥ã—ã‚„ã™ãã™ã‚‹ï¼‰
        executor.setThreadNamePrefix("ExpenseAsync-");

        // åˆæœŸåŒ–
        executor.initialize();

        return executor;
    }
}
```

**ğŸ“š å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ:**

1. **Observerãƒ‘ã‚¿ãƒ¼ãƒ³ï¼ˆã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ï¼‰**
   - ã‚µãƒ¼ãƒ“ã‚¹ã¯ã‚¤ãƒ™ãƒ³ãƒˆã‚’ç™ºè¡Œã™ã‚‹ã ã‘
   - ãƒªã‚¹ãƒŠãƒ¼ãŒã‚¤ãƒ™ãƒ³ãƒˆã‚’è³¼èª­ã—ã¦å‡¦ç†
   - ç–çµåˆï¼ˆLoose Couplingï¼‰ã‚’å®Ÿç¾

2. **Open/ClosedåŸå‰‡**
   - æ–°ã—ã„æ©Ÿèƒ½ï¼ˆSlacké€šçŸ¥ã€åˆ†æï¼‰ã‚’è¿½åŠ ã™ã‚‹ã¨ã
   - æ—¢å­˜ã®ã‚³ãƒ¼ãƒ‰ï¼ˆExpenseServiceï¼‰ã‚’å¤‰æ›´ã—ãªã„
   - æ–°ã—ã„ãƒªã‚¹ãƒŠãƒ¼ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ ã™ã‚‹ã ã‘

3. **éåŒæœŸå‡¦ç†**
   - `@Async`ã§æ™‚é–“ãŒã‹ã‹ã‚‹å‡¦ç†ã‚’åˆ¥ã‚¹ãƒ¬ãƒƒãƒ‰ã§å®Ÿè¡Œ
   - ãƒ¡ãƒ¼ãƒ«é€ä¿¡ãŒé…ãã¦ã‚‚æ‰¿èªå‡¦ç†ã‚’ãƒ–ãƒ­ãƒƒã‚¯ã—ãªã„
   - ãƒ¦ãƒ¼ã‚¶ãƒ¼ä½“é¨“ã®å‘ä¸Š

4. **Single Responsibilityï¼ˆå˜ä¸€è²¬ä»»ï¼‰**
   - ExpenseService: çµŒè²»ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®ã¿
   - NotificationListener: é€šçŸ¥ã®ã¿
   - AnalyticsListener: åˆ†æã®ã¿

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… æ–°æ©Ÿèƒ½ã‚’æ—¢å­˜ã‚³ãƒ¼ãƒ‰å¤‰æ›´ãªã—ã§è¿½åŠ å¯èƒ½
- âœ… é€šçŸ¥å¤±æ•—ã—ã¦ã‚‚ãƒ¡ã‚¤ãƒ³å‡¦ç†ã¯æˆåŠŸ
- âœ… å„ãƒªã‚¹ãƒŠãƒ¼ã‚’ç‹¬ç«‹ã—ã¦ãƒ†ã‚¹ãƒˆå¯èƒ½
- âœ… éåŒæœŸã§é«˜é€Ÿãªãƒ¬ã‚¹ãƒãƒ³ã‚¹

**æ‰€è¦æ™‚é–“:** 2-3æ—¥
**é›£æ˜“åº¦:** â­â­â­â˜†â˜†

---

### æ”¹å–„3: ãƒªãƒƒãƒãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ« ğŸ”´ é«˜å„ªå…ˆåº¦

**å•é¡Œç‚¹:**
ç¾åœ¨ã®Expenseã‚¯ãƒ©ã‚¹ã¯ã€Œè²§è¡€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ã€ã§ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã ã‘ã§ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãŒã‚ã‚Šã¾ã›ã‚“ã€‚

**ç¾åœ¨ã®ã‚³ãƒ¼ãƒ‰:**
```java
// src/main/java/com/example/expenses/domain/Expense.java
@Data  // Lombokã§getter/setterã‚’è‡ªå‹•ç”Ÿæˆ
public class Expense {
    private Long id;
    private Long applicantId;
    private String title;
    private BigDecimal amount;
    private String currency;
    private ExpenseStatus status;
    private LocalDateTime submittedAt;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    private int version;

    // ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ãŒãªã„ï¼ãŸã ã®ãƒ‡ãƒ¼ã‚¿å…¥ã‚Œç‰©
}

// ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯ã‚µãƒ¼ãƒ“ã‚¹ã«æ•£åœ¨
@Service
public class ExpenseService {
    public ExpenseResponse submit(Long expenseId) {
        Expense expense = expenseMapper.findById(expenseId);

        // ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ãŒã‚µãƒ¼ãƒ“ã‚¹ã«ã‚ã‚‹ - æ‚ªã„ï¼
        if (expense.getStatus() != ExpenseStatus.DRAFT) {
            throw new BusinessException("ä¸‹æ›¸ãã®ã¿æå‡ºå¯èƒ½");
        }

        expense.setStatus(ExpenseStatus.SUBMITTED);
        expense.setSubmittedAt(LocalDateTime.now());

        expenseMapper.update(expense);
    }
}
```

**å•é¡Œ:**
1. ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ãŒæ•£åœ¨ï¼ˆè¤‡æ•°ã®ã‚µãƒ¼ãƒ“ã‚¹ã«åŒã˜ãƒã‚§ãƒƒã‚¯ãŒé‡è¤‡ï¼‰
2. ç„¡åŠ¹ãªçŠ¶æ…‹ã‚’ä½œã‚Œã¦ã—ã¾ã†ï¼ˆsetterã§ç›´æ¥çŠ¶æ…‹å¤‰æ›´ï¼‰
3. ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã®å¤‰æ›´æ™‚ã«è¤‡æ•°ç®‡æ‰€ã‚’ä¿®æ­£

**æ”¹å–„å¾Œã®ã‚³ãƒ¼ãƒ‰ï¼ˆãƒªãƒƒãƒãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ï¼‰:**

```java
// src/main/java/com/example/expenses/domain/Expense.java
package com.example.expenses.domain;

import java.math.BigDecimal;
import java.time.LocalDateTime;
import lombok.Getter;

/**
 * çµŒè²»ã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ï¼ˆãƒªãƒƒãƒãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ç‰ˆï¼‰
 *
 * ãƒã‚¤ãƒ³ãƒˆ:
 * - @Dataã§ã¯ãªã@Getterã®ã¿ä½¿ç”¨ï¼ˆsetterã¯æä¾›ã—ãªã„ï¼‰
 * - ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ãƒ¡ã‚½ãƒƒãƒ‰ã¨ã—ã¦å®Ÿè£…
 * - ä¸æ­£ãªçŠ¶æ…‹é·ç§»ã‚’é˜²ã
 */
@Getter  // getterã®ã¿ç”Ÿæˆï¼ˆsetterã¯ä½œã‚‰ãªã„ï¼‰
public class Expense {
    private Long id;
    private Long applicantId;
    private String title;
    private BigDecimal amount;
    private String currency;
    private ExpenseStatus status;
    private LocalDateTime submittedAt;
    private LocalDateTime createdAt;
    private LocalDateTime updatedAt;
    private int version;

    /**
     * çµŒè²»ã‚’æ–°è¦ä½œæˆï¼ˆãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ï¼‰
     * å¿…ãšä¸‹æ›¸ãçŠ¶æ…‹ã§ä½œæˆã•ã‚Œã‚‹
     */
    public static Expense create(Long applicantId, String title,
                                BigDecimal amount, String currency) {
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        if (applicantId == null) {
            throw new IllegalArgumentException("ç”³è«‹è€…IDã¯å¿…é ˆã§ã™");
        }
        if (title == null || title.isBlank()) {
            throw new IllegalArgumentException("ã‚¿ã‚¤ãƒˆãƒ«ã¯å¿…é ˆã§ã™");
        }
        if (amount == null || amount.compareTo(BigDecimal.ZERO) <= 0) {
            throw new IllegalArgumentException("é‡‘é¡ã¯æ­£ã®æ•°ã§ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™");
        }

        Expense expense = new Expense();
        expense.applicantId = applicantId;
        expense.title = title;
        expense.amount = amount;
        expense.currency = currency != null ? currency : "JPY";
        expense.status = ExpenseStatus.DRAFT;  // å¿…ãšä¸‹æ›¸ãã‹ã‚‰
        expense.version = 0;
        expense.createdAt = LocalDateTime.now();
        expense.updatedAt = LocalDateTime.now();

        return expense;
    }

    /**
     * çµŒè²»ã‚’æå‡ºã™ã‚‹
     * ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«: ä¸‹æ›¸ãçŠ¶æ…‹ã®ã¿æå‡ºå¯èƒ½
     *
     * @throws IllegalStateException ä¸‹æ›¸ãä»¥å¤–ã‹ã‚‰æå‡ºã—ã‚ˆã†ã¨ã—ãŸå ´åˆ
     */
    public void submit() {
        // ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã‚’ãƒã‚§ãƒƒã‚¯
        if (this.status != ExpenseStatus.DRAFT) {
            throw new IllegalStateException(
                String.format("ä¸‹æ›¸ãçŠ¶æ…‹ã®çµŒè²»ã®ã¿æå‡ºå¯èƒ½ã§ã™ã€‚ç¾åœ¨ã®çŠ¶æ…‹: %s", this.status)
            );
        }

        // çŠ¶æ…‹ã‚’å¤‰æ›´
        this.status = ExpenseStatus.SUBMITTED;
        this.submittedAt = LocalDateTime.now();
        this.updatedAt = LocalDateTime.now();
    }

    /**
     * çµŒè²»ã‚’æ‰¿èªã™ã‚‹
     * ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«: æå‡ºæ¸ˆã¿çŠ¶æ…‹ã®ã¿æ‰¿èªå¯èƒ½
     *
     * @throws IllegalStateException æå‡ºæ¸ˆã¿ä»¥å¤–ã‹ã‚‰æ‰¿èªã—ã‚ˆã†ã¨ã—ãŸå ´åˆ
     */
    public void approve() {
        if (this.status != ExpenseStatus.SUBMITTED) {
            throw new IllegalStateException(
                String.format("æå‡ºæ¸ˆã¿ã®çµŒè²»ã®ã¿æ‰¿èªå¯èƒ½ã§ã™ã€‚ç¾åœ¨ã®çŠ¶æ…‹: %s", this.status)
            );
        }

        this.status = ExpenseStatus.APPROVED;
        this.updatedAt = LocalDateTime.now();
        this.version++;  // æ¥½è¦³çš„ãƒ­ãƒƒã‚¯ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ã‚¢ãƒƒãƒ—
    }

    /**
     * çµŒè²»ã‚’å´ä¸‹ã™ã‚‹
     * ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«: æå‡ºæ¸ˆã¿çŠ¶æ…‹ã®ã¿å´ä¸‹å¯èƒ½
     *
     * @param reason å´ä¸‹ç†ç”±ï¼ˆå¿…é ˆï¼‰
     * @throws IllegalStateException æå‡ºæ¸ˆã¿ä»¥å¤–ã‹ã‚‰å´ä¸‹ã—ã‚ˆã†ã¨ã—ãŸå ´åˆ
     * @throws IllegalArgumentException å´ä¸‹ç†ç”±ãŒç©ºã®å ´åˆ
     */
    public void reject(String reason) {
        if (this.status != ExpenseStatus.SUBMITTED) {
            throw new IllegalStateException(
                String.format("æå‡ºæ¸ˆã¿ã®çµŒè²»ã®ã¿å´ä¸‹å¯èƒ½ã§ã™ã€‚ç¾åœ¨ã®çŠ¶æ…‹: %s", this.status)
            );
        }

        if (reason == null || reason.isBlank()) {
            throw new IllegalArgumentException("å´ä¸‹ç†ç”±ã¯å¿…é ˆã§ã™");
        }

        this.status = ExpenseStatus.REJECTED;
        this.updatedAt = LocalDateTime.now();
        this.version++;
    }

    /**
     * æŒ‡å®šã•ã‚ŒãŸãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒçµŒè²»ã‚’æå‡ºå¯èƒ½ã‹ãƒã‚§ãƒƒã‚¯
     *
     * @param userId ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ID
     * @return æå‡ºå¯èƒ½ãªã‚‰true
     */
    public boolean canBeSubmittedBy(Long userId) {
        // æ‰€æœ‰è€…ã§ã€ã‹ã¤ä¸‹æ›¸ãçŠ¶æ…‹
        return this.applicantId.equals(userId) &&
               this.status == ExpenseStatus.DRAFT;
    }

    /**
     * çµŒè²»ãŒæ‰¿èªå¯èƒ½ãªçŠ¶æ…‹ã‹ãƒã‚§ãƒƒã‚¯
     */
    public boolean canBeApproved() {
        return this.status == ExpenseStatus.SUBMITTED;
    }

    /**
     * çµŒè²»ãŒå´ä¸‹å¯èƒ½ãªçŠ¶æ…‹ã‹ãƒã‚§ãƒƒã‚¯
     */
    public boolean canBeRejected() {
        return this.status == ExpenseStatus.SUBMITTED;
    }

    /**
     * çµŒè²»ãŒé«˜é¡ã‹ã©ã†ã‹ï¼ˆ10ä¸‡å††ä»¥ä¸Šï¼‰
     * ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ã®ä¾‹
     */
    public boolean isHighValue() {
        BigDecimal threshold = new BigDecimal("100000");
        return this.amount.compareTo(threshold) >= 0;
    }

    /**
     * çµŒè²»ãŒå¤ã„ã‹ï¼ˆæå‡ºã‹ã‚‰30æ—¥ä»¥ä¸ŠçµŒéï¼‰
     */
    public boolean isOld() {
        if (this.submittedAt == null) {
            return false;
        }
        return this.submittedAt.isBefore(LocalDateTime.now().minusDays(30));
    }

    /**
     * é‡‘é¡ã‚’æŒ‡å®šé€šè²¨ã§å–å¾—
     * ä»Šå¾Œã€é€šè²¨æ›ç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ã“ã“ã«å®Ÿè£…å¯èƒ½
     */
    public BigDecimal getAmountIn(String targetCurrency) {
        if (this.currency.equals(targetCurrency)) {
            return this.amount;
        }

        // å°†æ¥çš„ã«ç‚ºæ›¿æ›ç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’è¿½åŠ 
        // CurrencyConverter converter = ...
        // return converter.convert(this.amount, this.currency, targetCurrency);

        throw new UnsupportedOperationException(
            "é€šè²¨æ›ç®—ã¯æœªå®Ÿè£…ã§ã™: " + this.currency + " -> " + targetCurrency
        );
    }

    // MyBatisç”¨ã®å†…éƒ¨setterï¼ˆpackage-privateï¼‰
    // å¤–éƒ¨ã‹ã‚‰ã¯ä½¿ãˆãªã„ã‚ˆã†ã«ã™ã‚‹
    void setId(Long id) { this.id = id; }
    void setCreatedAt(LocalDateTime createdAt) { this.createdAt = createdAt; }
    void setUpdatedAt(LocalDateTime updatedAt) { this.updatedAt = updatedAt; }
    void setVersion(int version) { this.version = version; }

    // ãã®ä»–ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¯èª­ã¿å–ã‚Šå°‚ç”¨ï¼ˆsetterãªã—ï¼‰
}
```

**ã‚µãƒ¼ãƒ“ã‚¹ã®ç°¡ç´ åŒ–:**
```java
// src/main/java/com/example/expenses/service/ExpenseService.java
@Service
@RequiredArgsConstructor
public class ExpenseService {

    private final ExpenseMapper expenseMapper;
    private final AuthenticationContext authContext;
    private final ApplicationEventPublisher eventPublisher;

    /**
     * çµŒè²»ã‚’æ–°è¦ä½œæˆ
     * ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
     */
    public ExpenseResponse create(ExpenseCreateRequest req) {
        Long userId = authContext.getCurrentUserId();

        // ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰ã‚’ä½¿ç”¨
        // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã§å®Ÿè¡Œã•ã‚Œã‚‹
        Expense expense = Expense.create(
            userId,
            req.title(),
            req.amount(),
            req.currency()
        );

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«ä¿å­˜
        expenseMapper.insert(expense);

        // ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
        eventPublisher.publishEvent(
            new ExpenseCreatedEvent(expense.getId(), userId, traceId())
        );

        return ExpenseResponse.toResponse(expense);
    }

    /**
     * çµŒè²»ã‚’æå‡º
     * ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å§”è­²
     */
    @Transactional
    public ExpenseResponse submit(Long expenseId) {
        Long userId = authContext.getCurrentUserId();

        // çµŒè²»ã‚’å–å¾—
        Expense expense = expenseMapper.findById(expenseId);
        if (expense == null) {
            throw new NoSuchElementException("çµŒè²»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: " + expenseId);
        }

        // ãƒ‰ãƒ¡ã‚¤ãƒ³ã®ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã‚’ä½¿ç”¨
        // æ‰€æœ‰è€…ãƒã‚§ãƒƒã‚¯ã‚‚ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ã§
        if (!expense.canBeSubmittedBy(userId)) {
            throw new BusinessException(
                "NOT_AUTHORIZED",
                "ã“ã®çµŒè²»ã‚’æå‡ºã™ã‚‹æ¨©é™ãŒã‚ã‚Šã¾ã›ã‚“"
            );
        }

        // ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ã§æå‡ºï¼ˆçŠ¶æ…‹é·ç§»ãƒ«ãƒ¼ãƒ«ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³å†…ï¼‰
        expense.submit();

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°
        expenseMapper.update(expense);

        // ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
        eventPublisher.publishEvent(
            new ExpenseSubmittedEvent(expenseId, userId, traceId())
        );

        return ExpenseResponse.toResponse(expense);
    }

    /**
     * çµŒè²»ã‚’æ‰¿èª
     * ã‚·ãƒ³ãƒ—ãƒ«ã«ãªã£ãŸï¼
     */
    @Transactional
    public ExpenseResponse approve(Long expenseId, int version) {
        Long userId = authContext.getCurrentUserId();

        // çµŒè²»ã‚’å–å¾—
        Expense expense = expenseMapper.findById(expenseId);
        if (expense == null) {
            throw new NoSuchElementException("çµŒè²»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        }

        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãƒã‚§ãƒƒã‚¯ï¼ˆæ¥½è¦³çš„ãƒ­ãƒƒã‚¯ï¼‰
        if (expense.getVersion() != version) {
            throw new BusinessException(
                "CONCURRENT_MODIFICATION",
                "ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ›´æ–°ã•ã‚Œã¦ã„ã¾ã™"
            );
        }

        // ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ã§æ‰¿èª
        // ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ï¼ˆæå‡ºæ¸ˆã¿ã®ã¿æ‰¿èªå¯èƒ½ï¼‰ã¯ãƒ‰ãƒ¡ã‚¤ãƒ³å†…ã§ãƒã‚§ãƒƒã‚¯
        expense.approve();

        // ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ›´æ–°
        expenseMapper.update(expense);

        // ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œ
        eventPublisher.publishEvent(
            new ExpenseApprovedEvent(
                expenseId, userId, expense.getApplicantId(), traceId()
            )
        );

        return ExpenseResponse.toResponse(expense);
    }

    /**
     * çµŒè²»ã‚’å´ä¸‹
     */
    @Transactional
    public ExpenseResponse reject(Long expenseId, String reason, int version) {
        Long userId = authContext.getCurrentUserId();

        Expense expense = expenseMapper.findById(expenseId);
        if (expense == null) {
            throw new NoSuchElementException("çµŒè²»ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
        }

        if (expense.getVersion() != version) {
            throw new BusinessException(
                "CONCURRENT_MODIFICATION",
                "ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ›´æ–°ã•ã‚Œã¦ã„ã¾ã™"
            );
        }

        // ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¡ã‚½ãƒƒãƒ‰ã§å´ä¸‹
        // ç†ç”±ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã‚‚ãƒ‰ãƒ¡ã‚¤ãƒ³å†…
        expense.reject(reason);

        expenseMapper.update(expense);

        eventPublisher.publishEvent(
            new ExpenseRejectedEvent(
                expenseId, userId, expense.getApplicantId(), reason, traceId()
            )
        );

        return ExpenseResponse.toResponse(expense);
    }
}
```

**ğŸ“š å­¦ç¿’ãƒã‚¤ãƒ³ãƒˆ:**

1. **ãƒªãƒƒãƒãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ« vs è²§è¡€ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«**
   - **è²§è¡€**: ãƒ‡ãƒ¼ã‚¿ã ã‘ã€ãƒ­ã‚¸ãƒƒã‚¯ã¯ã‚µãƒ¼ãƒ“ã‚¹ã«
   - **ãƒªãƒƒãƒ**: ãƒ‡ãƒ¼ã‚¿ + ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã€è‡ªå·±å®Œçµ

2. **Tell, Don't AskåŸå‰‡**
   - âŒ æ‚ªã„: ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚µãƒ¼ãƒ“ã‚¹ã§åˆ¤æ–­
     ```java
     if (expense.getStatus() == DRAFT) {
         expense.setStatus(SUBMITTED);
     }
     ```
   - âœ… è‰¯ã„: ãƒ‰ãƒ¡ã‚¤ãƒ³ã«å‘½ä»¤ã™ã‚‹
     ```java
     expense.submit();  // ä¸­ã§åˆ¤æ–­
     ```

3. **ä¸å¤‰æ€§ï¼ˆImmutabilityï¼‰**
   - setterã‚’æä¾›ã—ãªã„
   - ãƒ“ã‚¸ãƒã‚¹ãƒ¡ã‚½ãƒƒãƒ‰ã§ã®ã¿çŠ¶æ…‹å¤‰æ›´
   - ä¸æ­£ãªçŠ¶æ…‹ã‚’ä½œã‚Œãªã„

4. **ãƒ•ã‚¡ã‚¯ãƒˆãƒªãƒ¼ãƒ¡ã‚½ãƒƒãƒ‰**
   - `Expense.create(...)` ã§ç”Ÿæˆ
   - ã‚³ãƒ³ã‚¹ãƒˆãƒ©ã‚¯ã‚¿ã¯ä½¿ã‚ãªã„
   - å¿…ãšæœ‰åŠ¹ãªçŠ¶æ…‹ã§ä½œæˆ

**ãƒ¡ãƒªãƒƒãƒˆ:**
- âœ… ãƒ“ã‚¸ãƒã‚¹ãƒ«ãƒ¼ãƒ«ãŒ1ç®‡æ‰€ã«é›†ç´„
- âœ… ä¸æ­£ãªçŠ¶æ…‹é·ç§»ã‚’é˜²ã’ã‚‹
- âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ­ã‚¸ãƒƒã‚¯ã®å†åˆ©ç”¨ãŒå®¹æ˜“
- âœ… ãƒ†ã‚¹ãƒˆã—ã‚„ã™ã„
- âœ… ãƒ‰ãƒ¡ã‚¤ãƒ³ãƒ¢ãƒ‡ãƒ«ãŒä»•æ§˜æ›¸ã«ãªã‚‹

**æ‰€è¦æ™‚é–“:** 5-7æ—¥
**é›£æ˜“åº¦:** â­â­â­â­â˜†

---

## æ©Ÿèƒ½1: ã‚«ãƒ†ã‚´ãƒªç®¡ç†ï¼ˆåˆç´šï¼‰

### å­¦ç¿’ç›®æ¨™
- Repositoryãƒ‘ã‚¿ãƒ¼ãƒ³ã®å®Ÿè·µ
- DTOãƒ‘ã‚¿ãƒ¼ãƒ³ã®ç†è§£
- RESTful APIã®è¨­è¨ˆ
- ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ã®å®Ÿè£…

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­è¨ˆ

```sql
-- V9__create_categories.sql
CREATE TABLE categories (
    id BIGINT AUTO_INCREMENT PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    color VARCHAR(7) DEFAULT '#6B7280',  -- 16é€²æ•°ã‚«ãƒ©ãƒ¼ã‚³ãƒ¼ãƒ‰
    icon VARCHAR(50) DEFAULT 'tag',      -- ã‚¢ã‚¤ã‚³ãƒ³å
    active BOOLEAN DEFAULT TRUE,          -- æœ‰åŠ¹/ç„¡åŠ¹ãƒ•ãƒ©ã‚°
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    UNIQUE KEY uk_category_name (name)    -- åå‰ã®é‡è¤‡ã‚’é˜²ã
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;

-- expensesãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚«ãƒ†ã‚´ãƒªIDã‚’è¿½åŠ 
ALTER TABLE expenses
ADD COLUMN category_id BIGINT,
ADD CONSTRAINT fk_expense_category
    FOREIGN KEY (category_id) REFERENCES categories(id);

-- æ¤œç´¢é«˜é€ŸåŒ–ã®ãŸã‚ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹
CREATE INDEX idx_expense_category ON expenses(category_id);

-- ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚«ãƒ†ã‚´ãƒªã‚’ç™»éŒ²
INSERT INTO categories (name, description, color, icon) VALUES
('äº¤é€šè²»', 'é›»è»Šã€ã‚¿ã‚¯ã‚·ãƒ¼ã€é£›è¡Œæ©Ÿãªã©ã®äº¤é€šè²»', '#3B82F6', 'airplane'),
('é£Ÿäº‹', 'ä¼šé£Ÿã€æ¥å¾…ã€å‡ºå¼µæ™‚ã®é£Ÿäº‹ä»£', '#EF4444', 'utensils'),
('äº‹å‹™ç”¨å“', 'æ–‡æˆ¿å…·ã€æ¶ˆè€—å“ãªã©', '#10B981', 'paperclip'),
('ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢', 'ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã€ã‚µãƒ–ã‚¹ã‚¯ãƒªãƒ—ã‚·ãƒ§ãƒ³', '#8B5CF6', 'code'),
('ç ”ä¿®', 'æ›¸ç±ã€ã‚»ãƒŸãƒŠãƒ¼ã€ç ”ä¿®è²»ç”¨', '#F59E0B', 'book'),
('æ¥å¾…äº¤éš›è²»', 'ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ¥å¾…ã€ã‚¤ãƒ™ãƒ³ãƒˆå‚åŠ è²»', '#EC4899', 'ticket'),
('ãã®ä»–', 'ãã®ä»–ã®çµŒè²»', '#6B7280', 'tag');
```

ç¶šãã¯æ¬¡ã®ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã§ä½œæˆã—ã¾ã™ã‹ï¼Ÿãã‚Œã¨ã‚‚ã€ç‰¹å®šã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«ã¤ã„ã¦ã‚‚ã£ã¨è©³ã—ãèª¬æ˜ã—ãŸæ–¹ãŒã‚ˆã‚ã—ã„ã§ã—ã‚‡ã†ã‹ï¼Ÿ
